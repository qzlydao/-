## 1. 无则插入，有则更新

## 2. 聚合函数 + group by


已有一张`makerar`表
| cname  | wmname | avg  |
| ------ | ------ | ---- |
| canada | zoro   | 2.00 |
| spain  | luffy  | 1.00 |
| spain  | usopp  | 5.00 |

期望得到的结果是：

| cname  | wmname | avg  |
| ------ | ------ | ---- |
| canada | zoro   | 2.00 |
| spain  | usopp  | 5.00 |

```sql
create table makerar(
	cname varchar(32),
	wmname varchar(32),
	avg numeric(5,2)
);

insert into makerar values
('canada', 'zoro', 2.00),
('spain', 'luffy', 1.00),
('span', 'usopp', 5.00);

-- 聚合查询且用到group by
select c.cname, m.wmname, c.max_avg from
(select cname, MAX(avg) as max_avg from makerar group by cname) as c
left join makerar m on c.cname = m.cname and c.max_avg = m.avg;

-- 其中子查询结果为
select cname, MAX(avg) as max_avg from makerar group by cname;

cname		max_avg
canada		2
spain			5
```

## 3. distinct和group by去重的区别

[PostgreSQL 数据库中 DISTINCT 关键字的 4 种用法](https://blog.csdn.net/horses/article/details/108884556)

   ```sql
   CREATE TABLE IF NOT EXISTS public.demo (
   	uuid integer DEFAULT nextval('demo_uuid_seq'::regclass) NOT NULL,
   	name character varying(32),
   	score integer,
   	PRIMARY KEY(uuid)
   );
   
   -- 插入大量数据
   insert into demo (name, score) values 
   ('hega', 93),
   ('cead', 99),
   ('cjgd', 83),
   ('jhia', 94),
   ...
   ('jhia', 94);
   
   -- name, score去重查询
   -- 使用distinc去重
   select distinct name, score from demo;
   
   -- 使用group by去重
   select name, score from demo group by name, score;
   ```

其实上述两中方法分别是在运算和存储上的权衡。

`distinct`需要将`col`列中的全部内容都存储在一个内存中，可以理解为一个`hash`结构，`key`为`col`的值，最后计算`hash`结构中有多少个`key`即可得到结果。很明显，需要将所有不同的值都存起来。内存消耗可能较大。

而`group by`的方式是先将`col`排序。而数据库中的`group`一般使用`sort`的方法，即数据库会先对`col`进行排序。而排序的基本理论是，时间复杂为`nlogn`，空间为1，然后只要单纯的计数就可以了。优点是空间复杂度小，缺点是要进行一次排序，执行时间会较长。

两中方法各有优劣，在使用的时候，我们需要根据实际情况进行取舍。具体情况可参考如下法则：

| 数据分布 | 去重方式 | 原因                                                         |
| -------- | -------- | ------------------------------------------------------------ |
| 离散     | group    | distinct空间占用较大，在时间复杂度允许的情况下，group 可以发挥空间复杂度优势 |
| 集中     | distinct | distinct空间占用较小，可以发挥时间复杂度优势                 |

两个极端：

1. 数据列的所有数据都一样，即去重计数的结果为1时，用distinct最佳
1. 如果数据列唯一，没有相同数值，用group 最好

## 4. 批量更新

### 4.2 无where条件，根据主键约束更新